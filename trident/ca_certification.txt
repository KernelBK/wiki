卡在位检测使用smc控制器上的引脚，插入拔出的电平和trident方案相反。

由于丢失中断，于是在程序中使用GPIO轮询的方式检测卡的插拔。


----------

汇报：

smart card接口认证过程中发现的问题

1. cold reset时间过长。影响错误卡消息提示出现的时间过慢，不符合要求的3秒。
造成的原因是7816协议定义*卡复位超时的时间是1.6s*，而程序中对不能够正常复位的卡需要复位3次。
feizhitao查证复位超时时间应该是40000/f=40000/3500000=12ms，
feizhitao查证复位超时时间应该是40000/f=40000/3500000=12ms，
待验证。

1. "不符合协议"是卡驱动需要处理的数据我也返回给应用程序，这些数据应用程序不应该看到。
出现这个问题是因为最初认为只要通过了卡的测试命令接口就没问题，但这些测试命令返回需要看到本来不用看到的数据，因此我就把这些数据给了应用程序。
这个问题杨木叶那边已经处理了。

1. 卡升级失败。需要系统地定位问题，yangmuye在做，还没确认问题在哪里。等待。

1. 卡接口信号电压不到5v的问题，设计中应该有一个芯片TDA8024，使得电压可控。
TDA8024这个芯片雄杰已经加上去，我这边需要重新验证卡的读写，卡在位检测的功能。
这个方案，存在的风险是插拔卡中断丢失，但有不能够通过现在gpio轮询去解决，因为这个芯片还负责了卡的上电，卡插上以后有一个激活的过程，是在控制器中发出的。
目前卡还不能够读写，需要进一步在驱动中调试。
可能需要向trident那边要smart card控制器的文档。

1. 复位应答有不一样情况，这个3次复位应答的情况，  
3b6c00004e544943f000537043617264  
000000004e544943f000537043617264  
3b6c00004e544943f000537043617264  
中间一组不同，
出现频率yangmuye还没告诉我。
待查。

----

4:46 下午 星期四, 七月 12, 2012  

卡插入的中断取反了一次。
TDA8024激活在驱动程中，检测到插卡以后
CMDVCC没有被soc控制。

7:19 下午 星期四, 七月 12, 2012  
我们原来板上直接将smart card接口和芯片的引脚相连接，现在使用TDA8024这个芯片和smart card连接，这个时候我查到卡的电源不能够正常供应，再具体是TDA8024的CMDVCC没有给信号。
我这边没有sc控制器的文档，不清楚控制这个信号的寄存器在哪里。
原来的驱动程序不能够工作，是我出差到trident那边搞定的。

	puFfactor:372, puDfactor:1.
	failed @example_smc.c 552.ret=10    
	error:failed @example_smc.c 553 retCode[10]
	failed @smc_demo.c 170.ret=6

----

8:45 上午 星期五, 七月 13, 2012

卡检测接口使用我们原来的电平逻辑，和trident相反。

ATR错误是在升级以后出现的，直接反复复位卡不能够复现出来。


汇报：

1. 卡升级失败。现在问题集中在复位应答（ATR）有一个不正常的返回，通过分析返回的数据不符合卡的复位应答的格式标准，但是驱动程序认为是正确的应答，返回的是复位应答接受成功。
刚刚yangmuye的邮件提到另外一个厂家的机顶盒也有出现ATR错误的情况，他们在这个时候驱动返回的是ATR错误。如果是这样的话，我们在收到出错了的复位应答以后告诉应用程序，应用程序会通知ca库，CA库会再走一遍这个流程。
我这边调查驱动里面接受这样ATR为什么认为是正确的。
yangmuye那边对读出来的ATR的第一个字节做判断，不是0x3b就认为ATR错误，通知CA库，这个流程就和那个厂家的ATR出错流程一致。如果这样还不能解决问题那就不仅仅是ATR正确与否的报告问题，需要分析ATR数据出错的原因。

1. 冷复位时间过长。解决问题的难度和造成的影响都不大，现在优先级降低了，还没有腾出时间来验证。

1. 卡接口信号电压不到5V。已经通过增加芯片，飞线暂时解决。有一些细节还需要优化：在位检测的逻辑，gpio还是TDA8024控制上电。

----------

升级的时候不能返回错误，返回失败后ca库就不在进行下一步动作，所以ATR就必须要对。

冷复位的时候需要一个下电操作，现在没有这个下电。我们可以采取热复位。
SMCReset最后一个参数改成FALSE。


汇报：

冷复位的时候需要一个下电操作（7816协议规定），没有加TDA8024的方案是直接就上电，避免这个问题的一个方案是软件采用热复位，但复位几次后就出失败了。
方案上加上TDA8024芯片，程序就只负责读写卡的数据，电源管理，复位卡的一些操作都由TDA8024管理了。
现在的问题我们可能怀疑是卡电源到5V造成，也有可能是在复位卡的时候没有一个下电过程引起。所以我觉得需要在这边先把加了TDA8024的这个方案调通再到北京去做认证的测试更稳妥。

----

7:42 下午 星期五, 七月 13, 2012


硬件那边没有进展。

我又发现一个问题，反复执行SMC程序，几百次之后电源会变成3.3V，但是每次程序中都会设置电压为5V。


硬件那边没有进展。

我又发现一个问题，反复执行SMC程序，几百次之后电源会变成3.3V，但是每次程序中都会设置电压为5V。

----

反复调用smc_demo会出现下面的错误。
	[SMC] SMCInit begin.
	[SMC] error: cnxt_smc_init failed.
	failed @smc_demo.c 148.ret=6


----

10:17 上午 星期一, 七月 16, 2012

模拟输出有花屏。有时候开机插上就是花屏的，插拔的时候也会有。出现以后就会一直存在，主界面出不来。

永新，单频点搜索538

h3.ditital不能换台。

卡升级使用加了TDA8024，电源采用GPIO，复位的时候有下电操作。
在升级的流程中，第一次插卡复位成功，之后下载完数据，再次复位卡失败，再次复位卡失败，再次复位卡成功。
一次复位卡失败这个流程就走不下去。

在驱动中确认复位应答有没有改动。

认证中的问题和解决情况汇报

1. 在永新这边配置好了测试环境，了解杨木叶做的升级流程，和原来log对应起来定位出错的问题。
使用了TDA8024以后复位错误的问题存在，我这边进一步跟复位应答的驱动。

1. 发现模拟输出有花屏。
有时候开机插上就是花屏的，插拔的时候也会有。出现以后就会一直存在，主界面出不来。
这个也会对测试有影响，因为测试项目中，对输出信号的插拔不能出现显示不正常。

1. 长时间拔掉cable线，不能继续播放。

1. 下载数据的问题是由于升级测试命令不正确造成。


9:59 上午 星期二, 七月 17, 2012

认证中的问题和解决情况汇报2

1. 长时间拔掉cable线，不能继续播放。 systa也能够复现出来。

1. 花屏，输出一闪一闪，频率1，2s的样子。
和显示有关的问题原建业在跟踪和解决。

1. ATR返回错误。在驱动能看到正常接收，在应用层的到的ATR的前两个字节被修改了。我还在进一步确认是在驱动里面被修改，还是在应用程序中被修改。

初步猜测，这个复位应答错误是由于接受完数据以后才出现，而且每次必现，所以在

这边测试需要轮流使用卡和我们显示界面的修改

1. TDA8024可能坏掉。

----

9:50 上午 星期三, 七月 18, 2012


[[log.ca.upgrade.5]]
[[log.ca.upgrade.6]]
[[log.ca.upgrade.7]]
[[log.ca.upgrade.8]]

stGetAtr 声明在内核空间，
uArgs 是用户空间的指针。

认证中的问题和解决情况汇报3

1. 做一个数码的release版本的smc驱动，加入对状态字的分析，去掉打印。

1. ATR返回错误  
函数cnxt\_lnx\_drv\_copy\_args只是执行了copy\_to\_user，证实了数据不是在内核空间被修改的。跟到这里，已经从中断程序接收数据到内核把数据复制到用户空间都走了一遍。
copy\_to\_user执行完后，再次检查ATR的值，在应用内核空间的值是正确的，在复制到用户空间的值是错误的。
假设copy\_to\_user没有错误（出错的机会很小）。再次使用copy\_to\_user复制一次ATR到用户空间，检查发现是正常的。  
cnxt_lnx_smc_get_atr atr 1: 3b 6c 00 00 4e 54 49 43 f0 00 53 70 43 61 72 64 // kernel ATR value  
cnxt_lnx_smc_get_atr atr 2: 00 00 00 00 4e 54 49 43 f0 00 53 70 43 61 72 64 // first copy to user read  
cnxt_lnx_smc_get_atr atr 3: 3b 6c 00 00 4e 54 49 43 f0 00 53 70 43 61 72 64 // do cnxt_lnx_drv_copy_args again   
再次复制ATR到用户空间以后，程序出现了崩溃，说明这片地址在一方有溢出，两边都写数据的话，必定有一方会崩溃。

1. 今天杨木叶在数码，明天会和他在应用程序中调试这个问题。

----

9:55 上午 星期四, 七月 19, 2012

认证中的问题和解决情况汇报4

1. ATR数据返回到应用层错误。  
进一步跟到ATR返回的指针在CA库里面，gdb没法跟踪那个地址的修改，
于是在复位程序中创建一个静态数组接收ATR，然后复制给接口的指针。这种情况函数本地的数据不被修改，传递给指针的数据也不被修改。  
CA库中提供的地址在每次调用smart card的reset时候都不同，可以推断出CA库里面是使用的malloc分配的接收数据空间。我们使用静态的数组不出错误，怀疑是malloc引起的错误。  
尝试：在函数内使用malloc分配一个ATR返回数据的空间，再返回给库的的指针，结果没有出问题。排除malloc引起的错误。
错误暂时绕了过去，能够走完升级的流程，但根本的原因需要时间继续调查。  
杨木叶也在和万博沟通希望我们继续跟进这个问题。  
现在对这个问题的推测：在内核调用完了系统调用ioctl（get atr）以后发生调度，内核或用户空间的某个进程“正好”修改了ATR开始的两个数据；或者个CA库中有问题，永新这边应该是不会配合我们查错。

1. gpio78引起内核崩溃。

----

11:51 上午 星期五, 七月 20, 2012

认证中的问题和解决情况汇报5

1. ATR返回给CA库指针错误。
	1. 在升级的时候用memtester测试内存没有错误发生。
	1. 执行smart card复位两次，第一次使用函数作用域内的变量接收数据，再拷贝到函数传递进来的指针，第二次直接使用传递进来的指针接收数据。结果是第一种方法的数据不被改变，第二种方法的数据仍然有被修改。

1. 数码那边的cable插拔，杨木叶和彭亮这周末回公司，我下午就过去复现现象。根据以前的经验，不播放是DVB-C子卡不出来数据，我们的驱动和子卡只能在系统启动以后复位初始化一次，不能多次初始化。所以不能通过复位子卡来解决这个问题。这边试过4块不同的板子都复现这个问题，而且是每次必现，从cctv4切换到别的频道又可以播放。我的思路是插拔cable以后不能播放的时候测量DVB-C子卡的TS输出，如果没有数据输出，芯片或板的问题更明显。

1. 内核崩溃

    Unable to handle kernel NULL pointer dereference at virtual address 00000018
    pgd = 8adc8000
	[00000018] *pgd=0adc5031, *pte=00000000, *ppte=00000000
	Internal error: Oops: 17 [#1] SMP
	last sysfs file: /sys/devices/platform/gpio_apollo.1/gpio/gpio78/value
	Modules linked in: irrx_dev 8192cu snd_cnxt snd_pcm snd_page_alloc snd_timer snd pvrnxpdc(P) pvrsrvkm(P) vpmfbDrv lnxpvrDrv lnxtmvssDrv(P) lnxtmasDrv(P) lnxcssDrv(P) lnxfssDrv(P) lnxscsDrv lnxplatDrv lnxnotifyqDrv lnxKKALDrv lnxplatnativeDrv

----

2012-07-24

晚上原出差去北京。

----

9:36 上午 星期四, 七月 26, 2012

原建业怀疑gpio造成内核崩溃。

使用ioctl的方式重写gpio驱动。

查看gpio78，80地址。


    PIO005 (卡在位) -> gpio_right Bit [4] -> 
		gpio78
		mode mask 0xE0669000 & 0x00000300
		data mask 0xE066903C & 0x00100010
    PIO007 (卡电源) -> gpio_right Bit [6] 
		gpio80
		mode mask 0xE0669000 & 0x00003000
		data mask 0xE066903C & 0x00400040

怀疑cnxt_smc_read_write造成内核崩溃。

怀疑 cnxt_kal_critsec_end 地方不对，有的代码不在锁之内。锁是加在数据上的。

----

8:46 上午 星期五, 七月 27, 2012

答邮件

1. 卡兼容测试有没有通过，存在什么问题？

1. 每台h2d死机概率都一样么？

1. smc驱动读写有没有返回的异常，卡死的情况下卡读写函数返回了没有？

[[log.smc.error.1]]
- h3.digital: page allocation failure. order:2, mode:0x4020
- Internal error: Oops: 5 [#1] SMP  
	-  I/O error
- Internal error: Oops: 17 [#1] SMP
	- File exists
- Process h3.Notice (pid: 1774, stack limit = 0x8b32c2f8)
- Unable to handle kernel paging request at virtual address 

----

2012-07-29 20:30

yuan电话

1. 把驱动改到用户空间。
	- 实现困难

----

2012-07-30 8:35

继续调试的一些思路

1. *跟踪ATR返回错误的真正原因。
	- 在内核中检查复制的数据应该用copy_from_user，不是直接使用指针。
	- 用户空间的修改，内存泄漏，
	- 内核空间的修改，页表错误，调度的pid
1. 从内核崩溃的oops开始调试。

1. 改变驱动加载的顺序。
1. 不运行其他的桌面程序。
1. 查看内存泄漏

1. smc驱动从sdk里剥离出来成为一个单独的驱动
- 驱动实现，使用cnxt_*的接口需要重新实现
- 接口定义，ioctl是否和原来的封装一致
- 调用方式改变

